# Telegram Story Bot

Бот для Telegram, который по команде `/wtf` генерирует рассказ о том, что происходило в чате за последние 12 часов на основе текстовых и голосовых сообщений участников дискуссии.

## Особенности

- Анализирует текстовые сообщения в чате
- Конвертирует голосовые и аудиосообщения в текст с помощью Google Speech-to-Text API
- Пытается получить историю сообщений, если доступных сообщений недостаточно
- Корректно определяет авторов пересланных сообщений, учитывая их в анализе
- Сохраняет сообщения между перезапусками бота (хранит в файле messages.json)
- Автоматически исключает команды "wtf" из контекста рассказа, чтобы не искажать анализ дискуссии
- Генерирует рассказ, содержащий информацию о:
  - Участниках дискуссии
  - Настроении и тоне обсуждения
  - Предмете обсуждения
  - Результатах и выводах дискуссии
- Использует Anthropic Claude 3.5 для генерации рассказов с высоким качеством и юмором
- Автоматически разбивает длинные рассказы на части для соблюдения ограничений Telegram
- Способ вызова команды:
  - `/wtf` - стандартная команда
  - `/wtf@имя_бота` - команда с указанием имени бота (для групповых чатов)

## Подготовка к запуску

1. Создайте бота в Telegram с помощью [@BotFather](https://t.me/BotFather) и получите токен для API
2. Зарегистрируйтесь в [Google Cloud](https://cloud.google.com/) и настройте доступ к Speech-to-Text API:
   - Создайте новый проект в Google Cloud Console
   - Включите API Speech-to-Text для вашего проекта
   - Создайте сервисный аккаунт: IAM & Admin → Service Accounts → Create Service Account
   - Введите имя сервисного аккаунта (например, "telegram-bot")
   - Добавьте роль "Speech-to-Text Admin" (Roles → Speech-to-Text → Speech-to-Text Admin)
   - Нажмите "Done", затем найдите свой сервисный аккаунт в списке
   - Нажмите на имя сервисного аккаунта → Keys → Add Key → Create New Key → JSON
   - Скачайте файл JSON с ключом (он будет автоматически загружен на ваш компьютер)
   - Переименуйте скачанный файл в `google-credentials.json` и поместите его в корневую директорию проекта
   
   **ВАЖНО:** Убедитесь, что формат JSON-файла соответствует стандартному формату ключа сервисного аккаунта Google:
   ```json
   {
     "type": "service_account",
     "project_id": "ваш-project-id",
     "private_key_id": "...",
     "private_key": "-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n",
     "client_email": "имя-сервисного-аккаунта@ваш-project-id.iam.gserviceaccount.com",
     "client_id": "...",
     "auth_uri": "https://accounts.google.com/o/oauth2/auth",
     "token_uri": "https://oauth2.googleapis.com/token",
     "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
     "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/..."
   }
   ```
   
   Не используйте OAuth client credentials (файлы, начинающиеся с `client_secret_`), так как они не будут работать с Google Speech-to-Text API.

3. Зарегистрируйтесь на [Anthropic](https://www.anthropic.com/) и получите API ключ для Claude

4. Установите Node.js (версия 14 или выше)

5. Клонируйте этот репозиторий

6. Установите зависимости:
   ```
   npm install
   ```

7. Создайте файл `.env` в корневой директории проекта и добавьте в него следующие строки:
   ```
   TELEGRAM_BOT_TOKEN=ваш_телеграм_токен
   ANTHROPIC_KEY=ваш_ключ_anthropic
   GOOGLE_APPLICATION_CREDENTIALS=./google-credentials.json
   ```

## Запуск бота

```
npm start
```

Или напрямую:

```
node index.js
```

## Использование

1. Добавьте бота в групповой чат
2. Дайте боту разрешение читать сообщения в чате (для групп необходимо сделать бота администратором)
3. Бот будет автоматически собирать и анализировать все текстовые, голосовые и аудиосообщения
4. В любой момент отправьте команду `/wtf` (или любой другой поддерживаемый вариант), и бот сгенерирует рассказ о том, что происходило в чате за последние 12 часов

## Технические особенности

- Бот сохраняет сообщения в файл data/messages.json каждые 5 минут и при завершении работы
- При запуске бот загружает ранее сохраненные сообщения
- Сообщения старше 12 часов автоматически удаляются
- Использует Telegram API для доступа к полной истории сообщений через аккаунт пользователя (при настройке)
- Автоматически скачивает и расшифровывает голосовые сообщения из истории чата
- Корректно определяет авторов пересланных сообщений, указывая в истории оригинального отправителя, а не того, кто переслал сообщение
- Фильтрует все варианты команды "wtf" из сообщений, отправляемых на обработку в Claude, чтобы избежать искажения контекста рассказа
- Информирует пользователя о количестве отфильтрованных команд "wtf" и пересланных сообщений перед генерацией рассказа
- Для обработки больших объемов сообщений применяется интеллектуальное сокращение данных
- Улучшенная система обработки команд, распознающая различные форматы вызова
- Для преобразования голосовых сообщений в текст используется Google Cloud Speech-to-Text API
- Для генерации рассказа используется Anthropic Claude 3.5 Sonnet

## Отладка

Бот выводит расширенную информацию о своей работе в консоль:
- Информация о каждом полученном сообщении
- Определение и обработка команд в различных форматах
- Логи о загрузке и сохранении истории сообщений
- Подробная информация о процессе генерации рассказа

## Зависимости

- telegraf: для работы с Telegram Bot API
- @google-cloud/speech: для преобразования речи в текст
- @anthropic-ai/sdk: для работы с Anthropic Claude API
- dotenv: для работы с переменными окружения
- axios: для HTTP-запросов
- fluent-ffmpeg и @ffmpeg-installer/ffmpeg: для работы с аудиофайлами

## Примечание

Бот сохраняет сообщения в файловой системе, поэтому история сообщений сохраняется между перезапусками бота. Однако, из-за ограничений Telegram Bot API, бот может получить доступ только к сообщениям, которые были отправлены после его добавления в чат и запуска.

## Структура проекта

После рефакторинга кода структура проекта организована следующим образом:

```
telegram-story-bot/
├── src/                  # Исходный код проекта
│   ├── index.js          # Точка входа в приложение
│   ├── services/         # Сервисы
│   │   ├── messageStorage.js     # Хранение и управление сообщениями
│   │   ├── speechToText.js       # Преобразование голоса в текст
│   │   ├── storyGenerator.js     # Генерация историй
│   │   └── telegramClient.js     # Работа с Telegram API
│   ├── handlers/         # Обработчики команд бота
│   │   └── botHandlers.js        # Обработчики команд и сообщений
│   └── utils/            # Вспомогательные утилиты (пока не используется)
├── data/                 # Директория для хранения данных
├── temp/                 # Временная директория для аудиофайлов
├── history/              # Директория для хранения истории сессий
├── .env                  # Файл с переменными окружения
├── package.json          # Зависимости проекта
└── README.md             # Документация проекта
```